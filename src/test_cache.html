<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Vaccinator Developer Class test</title>
    <meta charset="utf-8">  
    <style></style>
    <!-- start vaccinator include -->
    <script src="localforage.min.js"></script>
    <script src="forge-sha256.min.js"></script>
    <script src="aes.js"></script>
    <script src="vaccinator_api.js"></script>
    <!-- end vaccinator include -->
  </head>
  <body>
    <h1>Vaccinator Service API Class test -> Proxy connection</h1>
    <p>Check console log for results and information.</p>

    <script>
      const appid = "Rc-De_6nyCbb"; // Adapt to your needs. My APP-ID was 123456789
      
      example(); // call testing function (must be a function because of async)
      
      async function example() {
        try {
          var v = new vaccinator();
          // Set URL of proxy system (to avoid Same Origin Policy issues)
          await v.init("http://vaccinator.vsdevel.de.regify.com/service.php", 
                               "volker", appid, "password", true);

          // !!! Set some additional header for all network calls
          v.setHeaders( { 'Cache-Control': 'max-age=60' } );

          console.log("\n \n ");
          
          // !!! Create test data vData
          var vData = '';
          vData = '{"firstname":"Spongebob","lastname":"Square Pants", '+
                  '"Gender":"male","address_street":"Bikinistreet", '+
                  '"address_number":"42","address_city":"Bikini Bottom", '+
                  '"address_zip":"12345", "address_country":"Bikiniland", '+
                  '"address_phone":"","address_mail":"spongebob@bikinibottom.water", '+
                  '"company_location":"Crusty Krab", "date_og_birth":"01.02.1992", '+
                  '"profession":"Fry Cook", "attending_physician":"Sandy Cheeks"'+
                  '}';

          // !!! enter something that should be in cache
          console.log("Create some test object...");
          var vid = await v.new(vData);  
          if (vid === undefined) {
            console.error("Result is undefined!");
          } else {
            console.log("The new VID is " + vid);
          }

          console.log("\n \n ");

          // get from cache
          console.log("Retrieve from local cache...");
          vDataArray = await v.get(vid);
          console.log("Successfully received vData object array:");
          console.log(vDataArray);
          if (vDataArray[vid].status != "OK") {
            console.error("Missing stored data of VID "+vid);
          }
          if (v.fromCache.length != 1) {
            console.error("Data for "+vid+" should come from cache, but fromCache counter is != 1 ("+v.fromCache.length+")");
          }

          console.log("\n \n ");

          console.log("Wipe this object from local cache");
          await v.wipe(vid);

          console.log("\n \n ");

          // get again from cache (which is not here)
          console.log("Retrieve this object again...");
          vDataArray = await v.get(vid);
          console.log("Successfully received vData object array:");
          console.log(vDataArray);
          if (vDataArray[vid].status != "OK") {
            console.error("Missing stored data of VID "+vids[0]);
          }
          if (v.fromCache.length != 0) {
            console.error("Data for "+vid+" should not come from cache, but fromCache counter is != 0 ("+v.fromCache.length+")");
          }

          console.log("\n \n ");
          
          // !!! test delete() function
          vids = await v.delete(vid);
          console.log("Successfully removed the entry for vid(s) " + JSON.stringify(vids));
          
          console.log("\n \n ");
          
          // Done
          console.log("Test finished");

        } catch (e) {
          // catch any vaccinator class errors from here
          console.error("CATCHED ERROR:", e);
        }
      }
    </script>
  </body>
</html>