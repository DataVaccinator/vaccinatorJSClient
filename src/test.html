<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Vaccinator Developer Class test</title>
    <meta charset="utf-8">  
    <style></style>
    <!-- start vaccinator include -->
    <script src="localforage.min.js"></script>
    <script src="forge-sha256.min.js"></script>
    <script src="aes.js"></script>
    <script src="vaccinator_api.js"></script>
    <!-- end vaccinator include -->
  </head>
  <body>
    <h1>Vaccinator Service API Class test</h1>
    <p>Check console log for results and information.</p>

    <script>
      const appid = "Rc-De_6nyCbb"; // Adapt to your needs. My APP-ID was 123456789
      
      test(); // call testing function (must be a function because of async)
      
      async function test() {
        try {
          var a = new vaccinator();
          await a.init("http://vaccinator.vsdevel.de.regify.com/service.php", 
                               "volker", appid, "password", true);

          // !!! Set some additional header for all network calls
          a.setHeaders( { 'Cache-Control': 'max-age=60' } );
          
          // !!! Enable search function using "firstname" payload field
          a.enableSearchFunction( [ "firstname", "lastname" ] );
          
          // !!! Get some info from the server
          const serverInfo = await a.getServerInfo();
          console.log("Server-Info: " + JSON.stringify(serverInfo));

          // !!! Create test data payload
          var payload = '';
          payload = '{"firstname":"Spongebob","lastname":"Squarepants", '+
                    '"Gender":"male","address_street":"Bikini Street", '+
                    '"address_number":"42","address_city":"Bikini Bottom", '+
                    '"address_zip":"12345", "address_country":"Bikiniland", '+
                    '"address_phone":"","address_mail":"spongebob@bikinibottom.water", '+
                    '"company_location":"Crusty Krab", "date_og_birth":"01.02.1992", '+
                    '"profession":"Fry Cook", "attending_physician":"Sandy Cheeks"'+
                    '}';

          // !!! test userNew() function
          var pid = await a.userNew(payload);  
          console.log("The new user PID is " + pid);

          // !!! test userUpdate() function
          payload = '{"firstname":"Patrick","lastname":"Star"}';
          pid = await a.userUpdate(pid, payload);

          console.log("Successfully updated PID " + pid);

          // !!! test userWipe() function
          var pids = await a.userWipe(pid + " " + "dc2520e55dbc02d44a6ebc160cbffa62");
          console.log("Wiped user data from cache (force reload)");

          // !!! test userGet() function
          // use some unknown PID to simulate "not found" and trigger vaccinator call
          var toGet = [ pids[0], "0d52f1b0a314fba7d45e87ca5bf5e654" ];
          var payloadArray = await a.userGet(toGet);
          console.log("Successfully received payloads object array:");
          console.log(payloadArray);
          
          // !!! test search() function
          pids = await a.search("pat");
          console.log("Found using 'pat': " + JSON.stringify(pids));
          if (pids.length !== 1) { console.error("Wrong number of results!"); }
          pids = await a.search("nonsense");
          console.log("Found using 'nonsense': " + JSON.stringify(pids));
          if (pids.length !== 0) { console.error("Wrong number of results!"); }
          pids = await a.search("patr sta");
          console.log("Found using 'patr sta': " + JSON.stringify(pids));
          if (pids.length !== 1) { console.error("Wrong number of results!"); }
          pids = await a.search("patr tes");
          console.log("Found using 'patr tes': " + JSON.stringify(pids));
          if (pids.length !== 0) { console.error("Wrong number of results!"); }

          // !!! test userDelete() function
          pids = await a.userDelete(pid);
          console.log("Successfully removed the entry for user(s) " + JSON.stringify(pids));

          // !!! test wipeCache() function
          // A weekday token will force the cache to become
          // wiped every day (just as an example).
          const token = "token-weekday-" + new Date().getDay();
          var cacheWiped = await a.wipeCache(token);
          if (cacheWiped) {
            console.log("Cache wiped");
          } else {
            console.log("Cache NOT wiped");
          }

        } catch (e) {
          // catch any vaccinator class errors from here
          console.error(e);
        }
      }
    </script>
  </body>
</html>