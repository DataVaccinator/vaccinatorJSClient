<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Vaccinator Developer Class test</title>
    <meta charset="utf-8">  
    <style></style>
    <!-- start vaccinator include -->
    <script src="localforage.min.js"></script>
    <script src="forge-sha256.min.js"></script>
    <script src="jschacha20.js"></script>
    <script src="vaccinator_api.js"></script>
    <!-- end vaccinator include -->
  </head>
  <body>
    <h1>Vaccinator Service API Class test</h1>
    <p>Check console log for results and information.</p>

    <script>
      var appid = "Rc-De_6nyCbb"; // volker ID 123456789
      try {
        var a = new vaccinator();
        // var ret = await a.init("http://vaccinator.vsdevel.de.regify.com/service.php", "volker", "", "password", true);
        a.init("http://vaccinator.vsdevel.de.regify.com/service.php", "volker", appid, "password", true)
        .then(function() {
        
          // !!! Create test data payload
          var payload = '';
          payload = '{"firstname":"Spongebob","lastname":"Squarepants", '+
                    '"Gender":"male","address_street":"Bikini Street", '+
                    '"address_number":"42","address_city":"Bikini Bottom", '+
                    '"address_zip":"12345", "address_country":"Bikiniland", '+
                    '"address_phone":"","address_mail":"spongebob@bikinibottom.water", '+
                    '"company_location":"Crusty Krab", "date_og_birth":"01.02.1992", '+
                    '"profession":"Fry Cook", "attending_physician":"Sandy Cheeks"'+
                    '}';

          /*
          console.time("adding testdata");
          var promises = Array();
          for (var i = 0; i<1000; i++) {
            promises.push(a.userNew(payload));
          }
          Promise.all(promises).then(function() {
            console.timeEnd("adding testdata");
          });

          // test getAppId() function
          a.getAppId().then(function(id) {            
              console.log("The current AppId is " + id);
          });
          */

          // !!! test userNew() function
          a.userNew(payload)
          .then(function(pid) {
            console.log("The new user PID is " + pid);

            // !!! test userUpdate() function
            payload = '{"fn":"Patrick","ln":"Star"}';
            a.userUpdate(pid, payload)
            .then(function(pid) {
              console.log("Successfully updated PID " + pid);

              // !!! test userWipe() function
              a.userWipe(pid)
              .then(function(pids) { // returns array!
                console.log("Wiped user data from cache (force reload)");

                // !!! test userGet() function
                // use some unknown PID to simulate "not found" and trigger vaccinator call
                var toGet = Array(pids[0], "0d52f1b0a314fba7d45e87ca5bf5e654");
                a.userGet(toGet
                ).then(function(payloadArray) {
                  console.log("Successfully received payloads object array:");
                  console.log(payloadArray);

                  // !!! test userDelete() function
                  a.userDelete(pid).then(function(pids) {
                    console.log("Successfully removed the entry for user(s) " + JSON.stringify(pids));
                  });
                  
                  // !!! test wipeCache() function
                  // A weekday token will force the cache to become
                  // wiped every day (just as an example).
                  var token = "token-weekday-" + new Date().getDay();
                  a.wipeCache(token).then(function(cacheWiped) {
                    if (cacheWiped) {
                      console.log("Cache wiped");
                    } else {
                      console.log("Cache NOT wiped");
                    }
                  });
                });
              });
            });
          });
        });

      } catch (e) {
        // catch any vaccinator class errors from here
        console.error(e);
      }
    </script>
  </body>
</html>